(window.webpackJsonp=window.webpackJsonp||[]).push([[157],{414:function(t,s,a){"use strict";a.r(s);var n=a(0),r=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"pm2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pm2","aria-hidden":"true"}},[t._v("#")]),t._v(" PM2")]),t._v(" "),a("h2",{attrs:{id:"pm2-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pm2-2","aria-hidden":"true"}},[t._v("#")]),t._v(" pm2")]),t._v(" "),a("ul",[a("li",[t._v("pm2 是开源的基于 Nodejs 的进程管理器，包括守护进程、监控、日志的一整套完整的功能；")]),t._v(" "),a("li",[t._v("pm2 基本是 node 应用程序不二的守护进程选择；")]),t._v(" "),a("li",[t._v("事实上，pm2 并不仅仅可以启动 node 程序，对于一般的脚本程序同样可以胜任；")]),t._v(" "),a("li",[t._v("pm2 带有负载均衡功能，可以保持 node 应用进程永远运行在后台；")]),t._v(" "),a("li",[t._v("pm2 还有个非常强大的 deploy 功能，可以从本地直接部署线上网站。")])]),t._v(" "),a("h2",{attrs:{id:"node-与-pm2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-与-pm2","aria-hidden":"true"}},[t._v("#")]),t._v(" node 与 PM2")]),t._v(" "),a("ol",[a("li",[t._v("对于线上项目，如果直接通过 node app 来启动，如果报错了可能直接停止导致整个服务崩溃；")]),t._v(" "),a("li",[t._v("一般监控 node 的几种进程管理方案：\n"),a("ol",[a("li",[t._v("supervisor: 一般用作开发环境的使用；")]),t._v(" "),a("li",[t._v("forever: 管理多个站点，一般每个站点的访问量不大的情况，不需要监控；")]),t._v(" "),a("li",[t._v("PM2: 网站的访问量比较大，需要完整的监控页面。")])])]),t._v(" "),a("li",[t._v("pm2 的特性：\n"),a("ol",[a("li",[t._v("内建负载均衡（使用 Node cluster 集群模块）；")]),t._v(" "),a("li",[t._v("后台运行；")]),t._v(" "),a("li",[t._v("0 秒停机重载，维护升级时不需要停机；")]),t._v(" "),a("li",[t._v("具有 Ubuntu 和 CentOS 的启动脚本；")]),t._v(" "),a("li",[t._v("停止不稳定的进程（避免无限循环）；")]),t._v(" "),a("li",[t._v("控制台检测；")]),t._v(" "),a("li",[t._v("提供 HTTP API；")]),t._v(" "),a("li",[t._v("远程控制和实时的接口 API ( Nodejs 模块，允许和 PM2 进程管理器交互 )。")])])]),t._v(" "),a("li",[t._v("全局安装：npm install -g pm2")])]),t._v(" "),a("h2",{attrs:{id:"pm2-命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pm2-命令","aria-hidden":"true"}},[t._v("#")]),t._v(" PM2 命令")]),t._v(" "),a("ol",[a("li",[t._v("启动命令\n"),a("ol",[a("li",[t._v("pm2 start app.js：启动 nodeJs 应用，进程的默认名称为文件名 app")]),t._v(" "),a("li",[t._v("pm2 start app.js --name mynode：启动 node，并指定进程名称为 mynode")]),t._v(" "),a("li",[t._v("pm2 start app.js -i max：根据有效 CPU 数目启动最大进程数目")]),t._v(" "),a("li",[t._v("pm2 start app.js -i 3：启动 3 个进程")]),t._v(" "),a("li",[t._v("pm2 start app.js --watch：实时监控的方式启动，app.js 文件有变动时，pm2 会自动 reload")]),t._v(" "),a("li",[t._v("pm2 start app.js -x：用 fork 模式启动 app.js 而不是使用 cluster")]),t._v(" "),a("li",[t._v("pm2 start app.js -x -- -a 23：用 fork 模式启动 app.js 并且传递参数（-a 23）")]),t._v(" "),a("li",[t._v("pm2 start app.json：启动进程, 在 app.json 里设置选项")]),t._v(" "),a("li",[t._v("pm2 start app.js -i max -- -a 23：在 -- 之后给 app.js 传递参数")]),t._v(" "),a("li",[t._v("pm2 start app.js -i max -e err.log -o out.log：启动并生成一个配置文件")])])]),t._v(" "),a("li",[t._v("查看与监视进程\n"),a("ol",[a("li",[t._v("pm2 list：显示所有进程；")]),t._v(" "),a("li",[t._v("pm2 show 0，pm2 info 0：查看进程 id 为 0 的详细信息；")]),t._v(" "),a("li",[t._v("pm2 monit：进入监视页面，监视每个 node 进程的 CPU 和内存的使用情况。")])])]),t._v(" "),a("li",[t._v("停止、删除进程\n"),a("ol",[a("li",[t._v("pm2 stop/delete 0：停止/删除 id 为 0 的进程；")]),t._v(" "),a("li",[t._v("pm2 stop/delete all：停止/删除所有进程。")])])]),t._v(" "),a("li",[t._v("重启、重载\n"),a("ol",[a("li",[t._v("pm2 restart 0：重启 id 为 0 的进程；")]),t._v(" "),a("li",[t._v("pm2 restart all：重启所有进程；")]),t._v(" "),a("li",[t._v("pm2 reload 0：0 秒停机重载 id 为 0 进程（用于 NETWORKED 进程）；")]),t._v(" "),a("li",[t._v("pm2 reload all：重载所有进程。")])])]),t._v(" "),a("li",[t._v("日志操作\n"),a("ol",[a("li",[t._v("pm2 logs：显示所有进程的日志；")]),t._v(" "),a("li",[t._v("pm2 logs 0：显示进程 id 为 0 的日志；")]),t._v(" "),a("li",[t._v("pm2 flush：清空所有日志文件；")]),t._v(" "),a("li",[t._v("pm2 reloadLogs：重载所有日志。")])])]),t._v(" "),a("li",[t._v("pm2 startup：产生 init 脚本，保持进程活着。")])]),t._v(" "),a("h2",{attrs:{id:"pm2-启动-nuxt"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pm2-启动-nuxt","aria-hidden":"true"}},[t._v("#")]),t._v(" PM2 启动 nuxt")]),t._v(" "),a("ol",[a("li",[t._v("打包 nuxt 项目：npm run build")]),t._v(" "),a("li",[t._v("pm2 启动（Linux）：\n"),a("ol",[a("li",[t._v("pm2 start npm --name mynuxt -- start")]),t._v(" "),a("li",[t._v('pm2 start npm --name "my-nuxt" -- run start')])])]),t._v(" "),a("li",[t._v("默认情况下，用公网无法直接访问 nuxt，必须配置 nginx 转发，才能访问\n"),a("ol",[a("li",[t._v("nuxt 应用端口号为 3000")]),t._v(" "),a("li",[t._v("nginx 监听 80 端口，转发给 3000 端口，用公网访问 80 端口")])])]),t._v(" "),a("li",[t._v("配置 nuxt 的 package.json，直接通过公网访问 nuxt 应用\n"),a("ol",[a("li",[t._v('在 package.json 中添加一个新的节点，与"dependencies"同级\n"config": {\n"nuxt": {\n"host": "0.0.0.0",\n"port": 3000\n}\n}')]),t._v(" "),a("li",[t._v("服务器打开 nuxt 监听的端口 3000，即可访问")])])])]),t._v(" "),a("h2",{attrs:{id:"杀死-pm2-进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#杀死-pm2-进程","aria-hidden":"true"}},[t._v("#")]),t._v(" 杀死 PM2 进程")]),t._v(" "),a("ol",[a("li",[t._v("pm2 kill")])]),t._v(" "),a("h2",{attrs:{id:"配置文件启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置文件启动","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置文件启动")]),t._v(" "),a("p",[t._v("生成配置文件的命令"),a("code",[t._v("pm2 ecosystem")])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tapps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node-hxwj'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tscript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'index.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tinstances"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tautorestart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\twatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tmax_memory_restart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1G'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\toutput"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'logs/out.log'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\terror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'logs/error.log'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tlog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'logs/combined.outerr.log'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tenv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'development'")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tenv_production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("HOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'0.0.0.0'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8001")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tdeploy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tproduction"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tuser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\thost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'139.224.234.213'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'22'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tref"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'origin/master'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\trepo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'git@github.com:zhuqinb/node-hxwj.git'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tpath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/root/mygit/node-hxwj'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tssh_options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'StrictHostKeyChecking=no'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'post-deploy'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'npm install && pm2 reload ecosystem.config.js --env production'")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br")])]),a("h2",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考","aria-hidden":"true"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.jianshu.com/p/ba9036adaf5a?tdsourcetag=s_pctim_aiomsg",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.jianshu.com/p/ba9036adaf5a?tdsourcetag=s_pctim_aiomsg"),a("OutboundLink")],1)]),t._v(" "),a("ClientOnly",[a("article-info",{attrs:{weather:"qing",mood:"fendou"}},[t._v("2019年09月11日 19:50")])],1)],1)},[],!1,null,null,null);s.default=r.exports}}]);